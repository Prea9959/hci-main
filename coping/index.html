<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="referrer" content="no-referrer">
  
  <title>Calm &amp; Cope Learning Center</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    @font-face {
        font-family: "Comic Sans MS";
        src: url("https://db.onlinewebfonts.com/t/7cc6719bd5f0310be3150ba33418e72e.eot");
        src: url("https://db.onlinewebfonts.com/t/7cc6719bd5f0310be3150ba33418e72e.eot?#iefix")format("embedded-opentype"),
        url("https://db.onlinewebfonts.com/t/7cc6719bd5f0310be3150ba33418e72e.woff2")format("woff2"),
        url("https://db.onlinewebfonts.com/t/7cc6719bd5f0310be3150ba33418e72e.woff")format("woff"),
        url("https://db.onlinewebfonts.com/t/7cc6719bd5f0310be3150ba33418e72e.ttf")format("truetype"),
        url("https://db.onlinewebfonts.com/t/7cc6719bd5f0310be3150ba33418e72e.svg#Comic Sans MS")format("svg");
    }

    body {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Comic Sans MS', cursive, sans-serif;
        background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%);
        min-height: 100%;
    }

    html {
        height: 100%;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        padding-top: 110px;
    }

    /* Fixed Sticky Header */
    .header-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
        backdrop-filter: blur(5px);
    }
    
    .nav-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .language-selector {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 5px;
    }

    .lang-btn {
        background: #fff;
        border: 2px solid #0288d1;
        color: #0288d1;
        padding: 5px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .lang-btn.active {
        background: #0288d1;
        color: white;
    }

    .header-title {
        font-size: 1.2rem;
        color: #0288d1;
        margin: 0;
        font-weight: bold;
    }

    .header-content {
        text-align: center;
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .main-title {
        font-size: 2.5rem;
        color: #0288d1;
        margin-bottom: 8px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .welcome-text {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 0;
    }

    .sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    .section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        text-align: center;
    }

    .section-title {
        font-size: 2rem;
        color: #00bcd4;
        margin-bottom: 20px;
    }

    .breathing-section { border-top: 5px solid #81c784; }
    .grounding-section { border-top: 5px solid #4dd0e1; }
    .game-section { border-top: 5px solid #a5d6a7; grid-column: 1 / -1; }

    /* Breathing Circle */
    .breathing-circle {
        width: 150px;
        height: 150px;
        border: 4px solid #81c784;
        border-radius: 50%;
        margin: 20px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #4caf50;
        cursor: pointer;
        transition: all 0.5s ease;
    }

    .breathing-circle.active {
        animation: breathe 8s infinite ease-in-out;
    }

    @keyframes breathe {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); } 
    }

    .breathing-instructions {
        margin-top: 15px;
        font-size: 1.1rem;
        color: #4caf50;
        font-weight: bold;
        cursor: pointer;
    }

    /* Grounding Cards */
    .grounding-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .sense-card {
        background: linear-gradient(135deg, #e0f7fa, #f0fdfd);
        padding: 20px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .sense-card:hover {
        transform: translateY(-5px);
        border-color: #4dd0e1;
        box-shadow: 0 5px 20px rgba(77, 208, 225, 0.3);
    }

    .sense-card.active {
        border-color: #00bcd4;
        background: linear-gradient(135deg, #f0fdfd, #e0f7fa);
        transform: translateY(-5px);
    }

    .sense-image { 
        width: 80px; 
        height: 80px; 
        object-fit: cover; 
        border-radius: 50%;
        margin-bottom: 10px;
        border: 2px solid white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .sense-label { font-size: 1rem; color: #00838f; font-weight: bold; }

    .grounding-prompt {
        margin-top: 20px;
        padding: 15px;
        background: rgba(77, 208, 225, 0.1);
        border-radius: 10px;
        font-size: 1.1rem;
        color: #00838f;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* Game Styles */
    .game-container {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        padding: 30px;
        border-radius: 20px;
        margin-top: 20px;
    }

    .scenario-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .scenario-video {
        width: 100%;
        max-width: 450px;
        height: auto;
        border-radius: 15px;
        margin: 0 auto 20px auto;
        display: block;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        background-color: #000;
    }

    .scenario-text {
        font-size: 1.2rem;
        color: #333;
        margin-bottom: 20px;
        line-height: 1.5;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    /* === GAME BUTTONS LAYOUT (LEFT & RIGHT) === */
    .coping-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .coping-button {
        border: none;
        padding: 25px;
        border-radius: 15px;
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        font-weight: bold;
        background: white;
        border: 3px solid #e0e0e0;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 15px;
        height: 100%;
    }

    .coping-button img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid transparent;
        transition: transform 0.2s;
    }

    .coping-button:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        border-color: #4dd0e1;
    }
    
    .coping-button:hover img { transform: scale(1.1); }

    .feedback {
        margin-top: 15px;
        padding: 15px;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .feedback.correct { background: rgba(76, 175, 80, 0.1); color: #2e7d32; }
    .feedback.incorrect { background: rgba(244, 67, 54, 0.1); color: #c62828; }

    /* Buttons */
    .nav-button {
        background: linear-gradient(135deg, #64b5f6, #42a5f5);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 15px;
        font-family: inherit;
        font-weight: bold;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .nav-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(66, 165, 245, 0.4);
    }
    
    .secondary-btn {
        background: white;
        color: #555;
        border: 2px solid #ddd;
    }
    
    .secondary-btn:hover {
        background: #f0fbff;
        border-color: #0288d1;
        color: #0288d1;
    }

    /* Image Gallery */
    .image-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        text-align: center;
        margin-bottom: 30px;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .image-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 15px;
        transition: all 0.3s ease;
        position: relative;
    }

    .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .external-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .image-caption {
        font-size: 1rem;
        color: #666;
        font-weight: bold;
    }

    .audio-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        margin-top: 8px;
    }

    .play-button {
        background: linear-gradient(135deg, #4fc3f7, #0288d1);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.15s ease;
    }

    .play-button.paused {
        background: linear-gradient(135deg, #a5d6a7, #66bb6a);
        color: white;
    }

    .remove-button {
        background: #ff5722;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 5px;
        font-family: inherit;
        transition: all 0.3s ease;
    }

    /* Start Screen */
    .start-screen {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 24px;
        padding: 40px 20px;
        padding-top: 120px;
    }

    .start-top {
        width: 100%;
        max-width: 900px;
        display: flex;
        gap: 20px;
        justify-content: space-between;
        margin-top: 0;
        flex-wrap: wrap; 
    }

    .start-button {
        flex: 1;
        min-width: 200px; 
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 18px;
        border-radius: 16px;
        background: white;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        cursor: pointer;
        font-weight: bold;
        color: #444;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 2px solid transparent;
        font-size: 1.1rem;
    }

    .start-button:hover {
        transform: translateY(-6px);
        box-shadow: 0 14px 40px rgba(0,0,0,0.12);
        border-color: #4dd0e1;
    }

    .start-game {
        width: 100%;
        max-width: 900px;
        padding: 20px;
        border-radius: 16px;
        background: linear-gradient(135deg, #4dd0e1, #00bcd4);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        transition: transform 0.2s ease;
        border: 2px solid transparent;
        margin: 0;
    }
    
    .tts-icon {
        cursor: pointer;
        font-size: 1.2rem;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .tts-icon:hover { opacity: 1; }

    .hidden { display: none !important; }

  </style>
 </head>
 <body>

  <div class="header-nav">
     <div class="nav-top-row">
         <div class="header-title" id="navTitle">Calm & Cope</div>
         <button class="nav-button secondary-btn hidden" id="backToMenu" style="padding: 6px 12px; font-size: 0.9rem;">
             ‚Üê <span data-i18n="backMenu">Back to Menu</span>
         </button>
     </div>
     <div class="language-selector">
         <button class="lang-btn active" onclick="setLanguage('en')">English</button>
         <button class="lang-btn" onclick="setLanguage('ms')">Bahasa Melayu</button>
         <button class="lang-btn" onclick="setLanguage('zh')">‰∏≠Êñá</button>
     </div>
  </div>

  <div id="startScreen" class="start-screen">
    <div style="text-align:center; max-width:900px;">
      <h1 class="main-title" id="startMainTitle" data-i18n="mainTitle">Calm &amp; Cope Learning Center</h1>
      <p class="welcome-text" id="startWelcome" data-i18n="welcome">Choose an activity to get started</p>
    </div>

    <div class="start-top" role="navigation" aria-label="Main choices">
      <button class="start-button" id="btnImages">
        üñºÔ∏è <span data-i18n="btnImages">Calming Images</span>
      </button>
      <button class="start-button" id="btnBreathing">
        üå¨Ô∏è <span data-i18n="btnBreathing">Deep Breathing</span>
      </button>
      <button class="start-button" id="btnGrounding">
        üßò <span data-i18n="btnGrounding">Grounding (5-4-3-2-1)</span>
      </button>
    </div>

    <div class="start-game" id="btnGame">
        üéÆ <span data-i18n="btnGame">Play Choose-your-reaction game!</span>
    </div>
    
    <div class="start-game" id="btnLearnEmotion" style="background: linear-gradient(135deg, #7e57c2, #5e35b1);">
      <a href="https://hci-main-omega.vercel.app/" target="_blank" style="text-decoration: none; color: inherit; width: 100%; text-align: center;">
        üìò <span data-i18n="btnExternal">Back to Main Menu</span>
      </a>
    </div>
  </div>

  <div id="appContent" class="container hidden" aria-hidden="true">
   
   <div class="header-content">
    <h1 class="main-title" id="page-title" data-i18n="mainTitle">Calm &amp; Cope Learning Center</h1>
    <p class="welcome-text" id="page-subtitle" data-i18n="welcome">Learn helpful techniques to manage stress and anxiety</p>
   </div>

   <div id="imageSectionWrapper" class="image-section section hidden">
    <h2 class="section-title" data-i18n="btnImages">Calming Images</h2>
    <div class="url-input-section" style="background: transparent; box-shadow: none;">
      <div style="font-size:1rem; color:#555; padding:8px 12px; text-align:center;">
        <span data-i18n="imagesInstr">A selection of calming images with optional ambient sounds. Tap Play to listen.</span>
      </div>
    </div>
    <div class="image-gallery" id="imageGallery"></div>
    <button class="nav-button secondary-btn" onclick="goBack()" style="margin-top:20px;">
        ‚Üê <span data-i18n="backMenu">Back to Menu</span>
    </button>
   </div>

   <div id="breathingSectionWrapper" class="sections hidden">
    <div class="section breathing-section">
     <h2 class="section-title" data-i18n="btnBreathing">Deep Breathing</h2>
     <div id="breathingWrapper" style="display:flex; justify-content:center; align-items:center; gap:20px;">
         <div id="breathingCircle" class="breathing-circle">
            <span id="breathingText" data-i18n="clickStart">Click to Start</span>
         </div>
         <img id="breathingImage" src="image/breath-in.png" style="width:150px; height:150px; display:none;">
     </div>
     
     <audio id="breathingAudio" src="music/breathing_calm.mp3" loop></audio>

     <div class="breathing-instructions" id="breathingInstructions" onclick="speak(this.textContent)">
         <span data-i18n="breathInstr">Click the circle and breathe with the animation</span> üîä
     </div>
     <button class="nav-button secondary-btn" onclick="goBack()" style="margin-top:20px;">
        ‚Üê <span data-i18n="backMenu">Back to Menu</span>
    </button>
    </div>
   </div>

   <div id="groundingSectionWrapper" class="sections hidden">
    <div class="section grounding-section">
     <h2 class="section-title" data-i18n="btnGrounding">5-4-3-2-1 Grounding</h2>
     <div class="grounding-grid">
      <div class="sense-card" data-sense="see">
       <img src="image/eye_real.png" alt="See" class="sense-image" onerror="this.src='https://placehold.co/80x80/png?text=Eye'">
       <div class="sense-label">5 <span data-i18n="senseSee">See</span></div>
      </div>
      <div class="sense-card" data-sense="touch">
       <img src="image/hand_real.png" alt="Touch" class="sense-image" onerror="this.src='https://placehold.co/80x80/png?text=Hand'">
       <div class="sense-label">4 <span data-i18n="senseTouch">Touch</span></div>
      </div>
      <div class="sense-card" data-sense="hear">
       <img src="image/ear_real.png" alt="Hear" class="sense-image" onerror="this.src='https://placehold.co/80x80/png?text=Ear'">
       <div class="sense-label">3 <span data-i18n="senseHear">Hear</span></div>
      </div>
      <div class="sense-card" data-sense="smell">
       <img src="image/nose_real.png" alt="Smell" class="sense-image" onerror="this.src='https://placehold.co/80x80/png?text=Nose'">
       <div class="sense-label">2 <span data-i18n="senseSmell">Smell</span></div>
      </div>
      <div class="sense-card" data-sense="taste">
       <img src="image/tongue_real.png" alt="Taste" class="sense-image" onerror="this.src='https://placehold.co/80x80/png?text=Mouth'">
       <div class="sense-label">1 <span data-i18n="senseTaste">Taste</span></div>
      </div>
     </div>
     <div class="grounding-prompt" id="groundingPrompt" onclick="speak(this.textContent)">
        <span data-i18n="groundingStart">Click on a sense to start</span> üîä
     </div>
     <button class="nav-button secondary-btn" onclick="goBack()" style="margin-top:20px;">
        ‚Üê <span data-i18n="backMenu">Back to Menu</span>
    </button>
    </div>
   </div>

   <div id="gameSectionWrapper" class="sections hidden">
    <div class="section game-section">
     <h2 class="section-title" data-i18n="btnGame">Choose-your-reaction game</h2>
     <div class="game-container">
      <div class="progress-bar">
       <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      
      <div class="scenario-card" id="scenarioCard">
       <video id="scenarioVideo" class="scenario-video" autoplay loop muted playsinline style="display: none;">
           <source src="" type="video/mp4">
           Your browser does not support the video tag.
       </video>

       <div class="scenario-text">
           <span id="scenarioText">Loading...</span>
           <span class="tts-icon" onclick="speak(document.getElementById('scenarioText').textContent)">üîä</span>
       </div>

       <div class="coping-options" id="copingOptions"></div>
       
       <div class="feedback hidden" id="feedback">
           <span id="feedbackText"></span>
           <span class="tts-icon" onclick="speak(document.getElementById('feedbackText').textContent)">üîä</span>
       </div>

       <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
         <button class="nav-button" id="nextButton" style="display: none;">Next Scenario</button>
         <button class="nav-button secondary-btn" id="resetButton">Reset Game</button>
       </div>
      </div>
     </div>
     <button class="nav-button secondary-btn" onclick="goBack()" style="margin-top:20px;">
        ‚Üê <span data-i18n="backMenu">Back to Menu</span>
    </button>
    </div>
   </div>

  </div>

  <div id="endScreen" class="container hidden" aria-hidden="true">
    <div class="header-content">
      <h1 class="main-title" data-i18n="gameComplete">Game Complete!</h1>
      <p class="welcome-text">
          <span data-i18n="youScored">You scored</span> 
          <span id="finalScore">0</span> / <span id="totalQuestions">0</span>
      </p>
      <div style="margin-top:20px; display:flex; justify-content:center; gap:20px;">
        <button class="nav-button" id="restartGame">‚Üª <span data-i18n="playAgain">Play Again</span></button>
        <button class="nav-button secondary-btn" id="backToMenuFromEnd">‚Üê <span data-i18n="backMenu">Back to Menu</span></button>
      </div>
    </div>
  </div>

  <script>
    /* ================= TRANSLATIONS ================= */
    const translations = {
        en: {
            mainTitle: "Calm & Cope Learning Center",
            welcome: "Learn helpful techniques to manage your emotions!",
            btnImages: "Calming Images",
            btnBreathing: "Deep Breathing",
            btnGrounding: "Grounding (5-4-3-2-1)",
            btnGame: "Play Choose-your-reaction game!",
            
            // Fixed: Now consistent across languages
            btnExternal: "Back to Main Menu",
            
            backMenu: "Back to Menu",
            clickStart: "Click to Start",
            breathInstr: "Click the circle and breathe with the animation",
            breathIn: "Breathe In",
            breathOut: "Breathe Out",
            senseSee: "See",
            senseTouch: "Touch",
            senseHear: "Hear",
            senseSmell: "Smell",
            senseTaste: "Taste",
            groundingStart: "Click on a sense to start",
            playVideo: "Play Video",
            gameComplete: "Game Complete!",
            youScored: "You scored",
            playAgain: "Play Again",
            navTitle: "Calm & Cope",
            imagesInstr: "A selection of calming images with optional ambient sounds. Tap Play to listen.",
            btnRemove: "Remove",
            btnPlaySound: "Play Sound",
            btnPauseSound: "Pause Sound",
            
            // Added Missing Keys
            nextScenario: "Next Scenario",
            resetGame: "Reset Game",
            loading: "Loading..."
        },
        ms: {
            mainTitle: "Pusat Pembelajaran Kawalan Emosi",
            welcome: "Pelajari teknik berguna untuk mengurus emosi",
            btnImages: "Gambar Menenangkan",
            btnBreathing: "Pernafasan Dalam",
            btnGrounding: "Teknik Grounding (5-4-3-2-1)",
            btnGame: "Main Permainan Pilih Reaksi!",
            
            // Fixed: Matches 'Back to Main Menu'
            btnExternal: "Kembali ke Menu Utama",
            
            backMenu: "Kembali ke Menu",
            clickStart: "Klik Mula",
            breathInstr: "Klik bulatan dan bernafas ikut animasi",
            breathIn: "Tarik Nafas",
            breathOut: "Hembus Nafas",
            senseSee: "Lihat",
            senseTouch: "Sentuh",
            senseHear: "Dengar",
            senseSmell: "Bau",
            senseTaste: "Rasa",
            groundingStart: "Klik pada deria untuk bermula",
            playVideo: "Mainkan Video",
            gameComplete: "Permainan Tamat!",
            youScored: "Markah anda",
            playAgain: "Main Semula",
            navTitle: "Tenang & Atasi",
            imagesInstr: "Pilihan gambar menenangkan dengan bunyi. Tekan Main untuk dengar.",
            btnRemove: "Buang",
            btnPlaySound: "Main Bunyi",
            btnPauseSound: "Jeda Bunyi",
            
            // Added Missing Keys
            nextScenario: "Senario Seterusnya",
            resetGame: "Mula Semula",
            loading: "Sedang Memuatkan..."
        },
        zh: {
            mainTitle: "ÂÜ∑Èùô‰∏éÂ∫îÂØπÂ≠¶‰π†‰∏≠ÂøÉ",
            welcome: "Â≠¶‰π†ÁÆ°ÁêÜÊÉÖÁª™ÁöÑÂÆûÁî®ÊäÄÂ∑ß", // Fixed: 'emotions' instead of 'stress'
            btnImages: "Âπ≥ÈùôÁöÑÂõæÂÉè",
            btnBreathing: "Ê∑±ÂëºÂê∏",
            btnGrounding: "ÁùÄÂú∞Ê≥ï (5-4-3-2-1)",
            btnGame: "Áé©‚ÄòÈÄâÊã©‰Ω†ÁöÑÂèçÂ∫î‚ÄôÊ∏∏ÊàèÔºÅ",
            
            // Fixed: Matches 'Back to Main Menu'
            btnExternal: "ËøîÂõû‰∏ªËèúÂçï",
            
            backMenu: "ËøîÂõûËèúÂçï",
            clickStart: "ÁÇπÂáªÂºÄÂßã",
            breathInstr: "ÁÇπÂáªÂúÜÂúàÂπ∂Ë∑üÈöèÂä®ÁîªÂëºÂê∏",
            breathIn: "Âê∏Ê∞î",
            breathOut: "ÂëºÊ∞î",
            senseSee: "Áúã",
            senseTouch: "Ëß¶",
            senseHear: "Âê¨",
            senseSmell: "Èóª",
            senseTaste: "Â∞ù",
            groundingStart: "ÁÇπÂáªÊÑüÂÆòÂºÄÂßã",
            playVideo: "Êí≠ÊîæËßÜÈ¢ë",
            gameComplete: "Ê∏∏ÊàèÁªìÊùüÔºÅ",
            youScored: "‰Ω†ÁöÑÂæóÂàÜ",
            playAgain: "ÂÜçÁé©‰∏ÄÊ¨°",
            navTitle: "ÂÜ∑Èùô‰∏éÂ∫îÂØπ",
            imagesInstr: "Á≤æÈÄâÁöÑÂπ≥ÈùôÂõæÂÉèÂíåËÉåÊôØÈü≥„ÄÇÁÇπÂáªÊí≠ÊîæÊù•Êî∂Âê¨„ÄÇ",
            btnRemove: "ÁßªÈô§",
            btnPlaySound: "Êí≠ÊîæÂ£∞Èü≥",
            btnPauseSound: "ÊöÇÂÅúÂ£∞Èü≥",
            
            // Added Missing Keys
            nextScenario: "‰∏ã‰∏Ä‰∏™Âú∫ÊôØ",
            resetGame: "ÈáçÁΩÆÊ∏∏Êàè",
            loading: "Âä†ËΩΩ‰∏≠..."
        }
    };

    let currentLang = 'en';

    function setLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        
        loadScenario(); 
        rebuildGalleryText();
    }
    
    function rebuildGalleryText() {
        document.querySelectorAll('.play-button').forEach(btn => {
            if (!btn.classList.contains('paused')) {
                btn.textContent = translations[currentLang].btnPlaySound;
            } else {
                btn.textContent = translations[currentLang].btnPauseSound;
            }
        });
        document.querySelectorAll('.remove-button').forEach(btn => {
            btn.textContent = translations[currentLang].btnRemove;
        });
    }

    /* ================= UPDATED ROBUST TTS ================= */
    function speak(text) {
    // 1. Stop any existing audio or speech
    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
    
    const oldAudio = document.getElementById('tts-audio');
    if (oldAudio) { 
        oldAudio.pause(); 
        oldAudio.remove(); 
    }

    if (!text) return;

    // 2. Map currentLang to full Language Codes
    let langCode = 'en-US'; 
    if (currentLang === 'zh') langCode = 'zh-CN';
    if (currentLang === 'ms') langCode = 'ms-MY';

    // 3. Try Native Speech (Web Speech API) first
    const voices = window.speechSynthesis.getVoices();
    // Check if the browser has a voice that matches our language
    const hasNativeVoice = voices.some(v => v.lang.replace('_','-').includes(langCode.split('-')[0]));

    if (hasNativeVoice) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = langCode;
        
        // If native speech fails mid-way, trigger Google Fallback
        u.onerror = () => playGoogleFallback(text, langCode); 
        
        window.speechSynthesis.speak(u);
    } else {
        // 4. Fallback to Google Translate for all (including Chinese)
        playGoogleFallback(text, langCode);
    }
}

function playGoogleFallback(text, lang) {
    const audio = new Audio();
    audio.id = 'tts-audio';
    // Ensure we use the correct lang code (Google prefers 'zh-CN' or 'zh-TW')
    audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&client=gtx&tl=${lang}&q=${encodeURIComponent(text)}`;
    audio.play().catch(e => console.log("TTS Fallback Error:", e));
}

    /* ================= NAVIGATION ================= */
    const startScreen = document.getElementById('startScreen');
    const appContent = document.getElementById('appContent');
    const sections = document.querySelectorAll('.sections, .image-section');
    const backBtn = document.getElementById('backToMenu'); // Get reference to back button
    
    function showSection(id) {
        startScreen.classList.add('hidden');
        appContent.classList.remove('hidden');
        sections.forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // SHOW Back Button when entering activity
        if(backBtn) backBtn.classList.remove('hidden');
    }

    function goBack() {
        appContent.classList.add('hidden');
        startScreen.classList.remove('hidden');
        pauseAllAudios();
        stopBreathing();
        resetGame(); 
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // HIDE Back Button when returning to start
        if(backBtn) backBtn.classList.add('hidden');
    }

    document.getElementById('btnImages').onclick = () => showSection('imageSectionWrapper');
    document.getElementById('btnBreathing').onclick = () => showSection('breathingSectionWrapper');
    document.getElementById('btnGrounding').onclick = () => showSection('groundingSectionWrapper');
    document.getElementById('btnGame').onclick = () => showSection('gameSectionWrapper');
    document.getElementById('backToMenu').onclick = goBack;
    document.getElementById('backToMenuFromEnd').onclick = goBack;

    /* ================= CALMING IMAGES LOGIC ================= */
    const calmingImages = [
        { url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop", caption: "Peaceful Mountains", sound: "music/1.mp3" },
        { url: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&h=600&fit=crop", caption: "Serene Forest", sound: "music/5.mp3" },
        { url: "https://images.unsplash.com/photo-1439066615861-d1af74d74000?w=800&h=600&fit=crop", caption: "Tranquil Lake", sound: "music/3.mp3" },
        { url: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=800&h=600&fit=crop", caption: "Gentle Beach", sound: "music/4.mp3" },
        { url: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=800&h=600&fit=crop", caption: "Sunset Glow", sound: "music/5.mp3" },
        { url: "https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=800&h=600&fit=crop", caption: "Calm Desert", sound: "music/6.mp3" }
    ];

    const imageGallery = document.getElementById('imageGallery');

    function buildGallery() {
        imageGallery.innerHTML = '';
        calmingImages.forEach((item, idx) => {
            const card = document.createElement('div');
            card.className = 'image-card';
            
            const img = document.createElement('img');
            img.className = 'external-image';
            img.src = item.url;
            img.alt = item.caption;

            const caption = document.createElement('div');
            caption.className = 'image-caption';
            caption.textContent = item.caption;

            let audioElem = null;
            let playBtn = null;
            
            if (item.sound) {
                audioElem = document.createElement('audio');
                audioElem.src = item.sound;
                audioElem.loop = true;
                
                playBtn = document.createElement('button');
                playBtn.className = 'play-button';
                playBtn.textContent = translations[currentLang].btnPlaySound;
                playBtn.onclick = () => togglePlayAudio(idx, playBtn, audioElem);
            }

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'audio-controls';
            if (playBtn) controlsDiv.appendChild(playBtn);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-button';
            removeBtn.textContent = translations[currentLang].btnRemove;
            removeBtn.onclick = () => removeImage(removeBtn);

            card.appendChild(img);
            card.appendChild(caption);
            if (audioElem) card.appendChild(audioElem);
            card.appendChild(controlsDiv);
            card.appendChild(removeBtn);

            imageGallery.appendChild(card);
        });
    }

    function pauseAllAudios() {
        const audios = document.querySelectorAll('audio');
        audios.forEach(a => {
            a.pause();
            a.currentTime = 0;
            const card = a.closest('.image-card');
            if (card) {
                const btn = card.querySelector('.play-button');
                if (btn) {
                    btn.textContent = translations[currentLang].btnPlaySound;
                    btn.classList.remove('paused');
                }
            }
        });
    }

    function togglePlayAudio(index, button, audio) {
        if (!audio) return;
        const isPaused = audio.paused;
        if (isPaused) {
            pauseAllAudios();
            audio.play();
            button.textContent = translations[currentLang].btnPauseSound;
            button.classList.add('paused');
        } else {
            audio.pause();
            audio.currentTime = 0;
            button.textContent = translations[currentLang].btnPlaySound;
            button.classList.remove('paused');
        }
    }

    function removeImage(button) {
        const imageCard = button.parentElement;
        const audio = imageCard.querySelector('audio');
        if (audio) { try { audio.pause(); } catch (e) {} }
        imageCard.style.transform = 'scale(0)';
        setTimeout(() => imageCard.remove(), 300);
    }
    
    buildGallery();

    /* ================= BREATHING LOGIC ================= */
    const breathingCircle = document.getElementById('breathingCircle');
    const breathingText = document.getElementById('breathingText');
    const breathingImage = document.getElementById('breathingImage');
    const breathingAudio = document.getElementById('breathingAudio');
    let breathingActive = false;
    let breathingInterval;

    breathingCircle.onclick = () => {
        if (!breathingActive) startBreathing();
        else stopBreathing();
    };

    function startBreathing() {
        breathingActive = true;
        breathingCircle.classList.add('active');
        breathingImage.style.display = 'block';
        
        // Play Audio
        if(breathingAudio) breathingAudio.play().catch(e => console.log("Audio needed interaction"));

        runBreathCycle('in'); 
        let phase = 'out';
        breathingInterval = setInterval(() => {
            runBreathCycle(phase);
            phase = phase === 'in' ? 'out' : 'in';
        }, 4000);
    }

    function runBreathCycle(phase) {
        if (phase === 'in') {
            breathingText.textContent = translations[currentLang].breathIn;
            breathingCircle.style.backgroundColor = '#ef5350';
            breathingCircle.style.border = '4px solid #ef5350';
            breathingCircle.style.color = 'white';
            breathingImage.src = 'image/breath-in.png'; 
            speak(translations[currentLang].breathIn);
        } else {
            breathingText.textContent = translations[currentLang].breathOut;
            breathingCircle.style.backgroundColor = '#66bb6a';
            breathingCircle.style.border = '4px solid #66bb6a';
            breathingCircle.style.color = 'white';
            breathingImage.src = 'image/breath-out.png'; 
            speak(translations[currentLang].breathOut);
        }
    }

    function stopBreathing() {
        breathingActive = false;
        clearInterval(breathingInterval);
        breathingCircle.classList.remove('active');
        breathingText.textContent = translations[currentLang].clickStart;
        breathingCircle.style.backgroundColor = 'transparent';
        breathingCircle.style.border = '4px solid #81c784';
        breathingCircle.style.color = '#4caf50';
        breathingImage.style.display = 'none';
        
        // Stop Audio
        if(breathingAudio) {
            breathingAudio.pause();
            breathingAudio.currentTime = 0;
        }
        
        window.speechSynthesis.cancel();
    }

    /* ================= GROUNDING LOGIC ================= */
    const groundingData = {
        see: { en: "Look for 5 blue things", ms: "Cari 5 benda biru", zh: "ÂØªÊâæ5‰∏™ËìùËâ≤ÁöÑ‰∏úË•ø" },
        touch: { en: "Feel 4 different textures", ms: "Rasa 4 tekstur berbeza", zh: "ÊÑüÂèó4Áßç‰∏çÂêåÁöÑË¥®Âú∞" },
        hear: { en: "Listen for 3 distinct sounds", ms: "Dengar 3 bunyi berbeza", zh: "Âê¨3ÁßçÁã¨ÁâπÁöÑÂ£∞Èü≥" },
        smell: { en: "Find 2 pleasant smells", ms: "Cari 2 bau yang wangi", zh: "ÂØªÊâæ2ÁßçÂ•ΩÈóªÁöÑÊ∞îÂë≥" },
        taste: { en: "Recall 1 favorite taste", ms: "Ingat 1 rasa kegemaran", zh: "ÂõûÂøÜ1ÁßçÂñúÊ¨¢ÁöÑÂë≥ÈÅì" }
    };

    document.querySelectorAll('.sense-card').forEach(card => {
        card.onclick = function() {
            document.querySelectorAll('.sense-card').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const sense = this.dataset.sense;
            const text = groundingData[sense][currentLang];
            
            const promptBox = document.getElementById('groundingPrompt');
            promptBox.textContent = text + " üîä";
            speak(text);
        };
    });

    /* ================= GAME LOGIC (FULL 5 QUESTIONS) ================= */
    const scenarios = [
        { 
            id: 1, video: "videos/scenario1.mp4", 
            options: [
                { textKey: "sad", correct: true, face: "image/face_sad.png" }, 
                { textKey: "happy", correct: false, face: "image/face_happy.png" }
            ] 
        },
        { 
            id: 2, video: "videos/scenario2.mp4", 
            options: [
                { textKey: "happy", correct: true, face: "image/face_happy.png" }, 
                { textKey: "sad", correct: false, face: "image/face_sad.png" }
            ] 
        },
        { 
            id: 3, video: "videos/scenario3.mp4", 
            options: [
                { textKey: "happy", correct: true, face: "image/face_happy.png" }, 
                { textKey: "angry", correct: false, face: "image/face_angry.png" }
            ] 
        },
        { 
            id: 4, video: "videos/scenario4.mp4", 
            options: [
                { textKey: "angry", correct: true, face: "image/face_angry.png" }, 
                { textKey: "happy", correct: false, face: "image/face_happy.png" }
            ] 
        },
        { 
            id: 5, video: "videos/scenario5.mp4", 
            options: [
                { textKey: "scared", correct: true, face: "image/face_scared.png" }, 
                { textKey: "angry", correct: false, face: "image/face_angry.png" }
            ] 
        }
    ];

    const gameText = {
        1: {
            question: { en: "Your toy breaks. How do you feel?", ms: "Mainan anda rosak. Apa perasaan anda?", zh: "‰Ω†ÁöÑÁé©ÂÖ∑Âùè‰∫Ü„ÄÇ‰Ω†ÊÑüËßâÂ¶Ç‰ΩïÔºü" },
            sad: { en: "Sad", ms: "Sedih", zh: "‰º§ÂøÉ" },
            happy: { en: "Happy", ms: "Gembira", zh: "ÂºÄÂøÉ" },
            feedbackCorrect: { en: "Correct! It is okay to be sad.", ms: "Betul! Tidak mengapa untuk bersedih.", zh: "Ê≠£Á°ÆÔºÅ‰º§ÂøÉÊòØÊ≤°ÂÖ≥Á≥ªÁöÑ„ÄÇ" },
            feedbackWrong: { en: "Not quite.", ms: "Kurang tepat.", zh: "‰∏çÂ§™ÂØπ„ÄÇ" }
        },
        2: {
            question: { en: "You got a gift! How do you feel?", ms: "Anda dapat hadiah! Apa perasaan anda?", zh: "‰Ω†Êî∂Âà∞‰∫ÜÁ§ºÁâ©ÔºÅ‰Ω†ÊÑüËßâÂ¶Ç‰ΩïÔºü" },
            happy: { en: "Happy", ms: "Gembira", zh: "ÂºÄÂøÉ" },
            sad: { en: "Sad", ms: "Sedih", zh: "‰º§ÂøÉ" },
            feedbackCorrect: { en: "Yes! Gifts make us happy.", ms: "Ya! Hadiah buat kita gembira.", zh: "ÊòØÁöÑÔºÅÁ§ºÁâ©ËÆ©Êàë‰ª¨ÂºÄÂøÉ„ÄÇ" },
            feedbackWrong: { en: "Try again.", ms: "Cuba lagi.", zh: "ÂÜçËØï‰∏ÄÊ¨°„ÄÇ" }
        },
        3: {
            question: { en: "Your friend shares a toy. How do you feel?", ms: "Kawan berkongsi mainan. Apa perasaan anda?", zh: "ÊúãÂèãÂàÜ‰∫´Áé©ÂÖ∑„ÄÇ‰Ω†ÊÑüËßâÂ¶Ç‰ΩïÔºü" },
            happy: { en: "Happy", ms: "Gembira", zh: "ÂºÄÂøÉ" },
            angry: { en: "Angry", ms: "Marah", zh: "ÁîüÊ∞î" },
            feedbackCorrect: { en: "That's right! Sharing makes us happy.", ms: "Betul! Berkongsi buat kita gembira.", zh: "Ê≤°ÈîôÔºÅÂàÜ‰∫´ËÆ©Êàë‰ª¨Âø´‰πê„ÄÇ" },
            feedbackWrong: { en: "Not quite.", ms: "Kurang tepat.", zh: "‰∏çÂ§™ÂØπ„ÄÇ" }
        },
        4: {
            question: { en: "Your friend hit you. What is your reaction?", ms: "Kawan memukul anda. Apa reaksi anda?", zh: "ÊúãÂèãÊâì‰∫Ü‰Ω†„ÄÇ‰Ω†ÁöÑÂèçÂ∫îÊòØ‰ªÄ‰πàÔºü" },
            angry: { en: "Angry", ms: "Marah", zh: "ÁîüÊ∞î" },
            happy: { en: "Happy", ms: "Gembira", zh: "ÂºÄÂøÉ" },
            feedbackCorrect: { en: "It is natural to feel angry when hurt.", ms: "Adalah normal untuk rasa marah bila disakiti.", zh: "Âèó‰º§Êó∂ÊÑüÂà∞ÁîüÊ∞îÊòØÊ≠£Â∏∏ÁöÑ„ÄÇ" },
            feedbackWrong: { en: "We usually don't feel happy when hit.", ms: "Kita biasanya tak gembira bila dipukul.", zh: "Ë¢´ÊâìÊó∂ÈÄöÂ∏∏‰∏ç‰ºöÊÑüÂà∞ÂºÄÂøÉ„ÄÇ" }
        },
        5: {
            question: { en: "You are alone in a dark room. What emotion is this?", ms: "Anda sendirian di bilik gelap. Apa emosi ini?", zh: "‰Ω†Áã¨Ëá™Âú®ÈªëÊöóÁöÑÊàøÈó¥Èáå„ÄÇËøôÊòØ‰ªÄ‰πàÊÉÖÁª™Ôºü" },
            scared: { en: "Scared", ms: "Takut", zh: "ÂÆ≥ÊÄï" },
            angry: { en: "Angry", ms: "Marah", zh: "ÁîüÊ∞î" },
            feedbackCorrect: { en: "That's right! The dark can be scary.", ms: "Betul! Gelap boleh menakutkan.", zh: "Ê≤°ÈîôÔºÅÈªëÊöóÂèØËÉΩ‰ºöËÆ©‰∫∫ÂÆ≥ÊÄï„ÄÇ" },
            feedbackWrong: { en: "It is more common to feel scared.", ms: "Lebih biasa untuk rasa takut.", zh: "ÊÑüÂà∞ÂÆ≥ÊÄïÊòØÊõ¥Â∏∏ËßÅÁöÑÂèçÂ∫î„ÄÇ" }
        }
    };

    let currentScenario = 0;
    let gameScore = 0;
    
    const scenarioVideo = document.getElementById('scenarioVideo');
    const copingOptions = document.getElementById('copingOptions');
    const feedbackArea = document.getElementById('feedback');
    const nextButton = document.getElementById('nextButton');
    const resetButton = document.getElementById('resetButton');

    function loadScenario() {
        const scenario = scenarios[currentScenario];
        const texts = gameText[scenario.id];

        // Reset UI
        feedbackArea.classList.add('hidden');
        nextButton.style.display = 'none';
        
        // Video
        if (scenario.video) {
            scenarioVideo.src = scenario.video;
            scenarioVideo.load();
            scenarioVideo.style.display = 'block';
            scenarioVideo.play().catch(e => console.log("Autoplay blocked"));
            scenarioVideo.onerror = function() { this.style.display = 'none'; };
        } else {
            scenarioVideo.style.display = 'none';
        }
        
        // Question Text
        const qText = texts.question[currentLang];
        document.getElementById('scenarioText').textContent = qText;

        // Options
        copingOptions.innerHTML = '';
        scenario.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'coping-button';
            // Face + Text logic restored
            btn.innerHTML = `<img src="${opt.face}" onerror="this.style.display='none'"> ${texts[opt.textKey][currentLang]}`;
            
            // Standard Styling
            btn.style.background = 'white'; 
            btn.style.color = '#333333'; 
            btn.style.border = '2px solid #e0e0e0'; 
            
            btn.onclick = () => handleAnswer(opt, scenario, btn);
            copingOptions.appendChild(btn);
        });
    }

    function handleAnswer(option, scenario, clickedBtn) {
        const texts = gameText[scenario.id];
        const isCorrect = option.correct;
        
        // Feedback UI
        const fbText = isCorrect ? texts.feedbackCorrect[currentLang] : texts.feedbackWrong[currentLang];
        document.getElementById('feedbackText').textContent = fbText;
        feedbackArea.classList.remove('hidden');
        feedbackArea.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
        
        speak(fbText); 

        // Visual Feedback on Buttons
        document.querySelectorAll('.coping-button').forEach(b => {
            b.disabled = true;
            b.style.border = 'none';
        });
        
        if (isCorrect) {
            clickedBtn.classList.add('correct');
            clickedBtn.style.background = '#4caf50'; 
            clickedBtn.style.color = 'white';
            gameScore++;
        } else {
            clickedBtn.classList.add('incorrect');
            clickedBtn.style.background = '#ef5350'; 
            clickedBtn.style.color = 'white';
        }

        if (currentScenario < scenarios.length - 1) {
            nextButton.textContent = "Next Scenario";
            nextButton.style.display = 'inline-block';
            nextButton.onclick = () => {
                currentScenario++;
                loadScenario();
            };
        } else {
            nextButton.textContent = translations[currentLang].gameComplete;
            nextButton.style.display = 'inline-block';
            nextButton.onclick = showEndScreen;
        }
    }
    
    // Reset Game
    resetButton.onclick = resetGame;
    document.getElementById('restartGame').onclick = () => {
        document.getElementById('endScreen').classList.add('hidden');
        appContent.classList.remove('hidden');
        resetGame();
    };

    function resetGame() {
        currentScenario = 0;
        gameScore = 0;
        loadScenario();
    }
    
    function showEndScreen() {
        appContent.classList.add('hidden');
        const endScreen = document.getElementById('endScreen');
        endScreen.classList.remove('hidden');
        document.getElementById('finalScore').textContent = gameScore;
        document.getElementById('totalQuestions').textContent = scenarios.length;
        if(window.confetti) confetti();
    }

    // Initialize
    loadScenario();
  </script>
 </body>
</html>
